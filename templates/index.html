<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>IATI Data Store CSV Query Builder (Alpha Version)</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link href="static/css/custom.css" type="text/css" rel="stylesheet">
    <link href="static/css/bootstrap-chosen.css" type="text/css" rel="stylesheet">
  </head>
  <body dir="ltr">
    <div class="container">
      <div class="header row">
        <div class="col">
          <h1 dir="ltr">IATI Data Store CSV Query Builder (Alpha Version)</h1>
          <p>Please read the <a href="http://datastore.iatistandard.org/docs/user-guide/">user guide</a></p>
        </div>
      </div><!-- end class="header" -->

      <div class="query-builder">
        <div class="row"><!-- result -->
          {% if api_link %}
            <div class="alert alert-success" role="alert">
              <strong>Your link:</strong> <a href="{{ api_link }}">{{ api_link|escape }}</a>
            </div>

            {% if notice_message %}
              <div class="alert alert-warning" role="alert">
                <strong>Warning:</strong> {{ notice_message }}
              </div>
            {% endif %}

          {% elseif error_message %}
            <div class="alert alert-danger" role="alert">
              <strong>Error:</strong> {{ error_message }}
            </div>
          {% endif %}
        </div>

        <form action="index.php" method="post" target="_self" onsubmit="">

          <div class="form-row">
            <div class="col">
              <label for="dataset">
                <div>Choose format
                  <label for="itemView.getDomIdToLabel()" aria-label="(Required field)"></label>
                </div>
              </label>
              <ul id="qb-format-list">
                <li>
                  <label>
                    <input type="radio" name="dataset" value="activity" id="dataset-1" aria-label="Activity"
                    {% if not dataset or (dataset and dataset == "activity") %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>One activity per row</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="dataset" value="transaction" id="dataset-2" aria-label="Transaction"
                    {% if dataset and dataset == "transaction" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>One transaction per row</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="dataset" value="budget" id="dataset-3" aria-label="Budget"
                    {% if dataset and dataset == "budget" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>One budget per row</span>
                  </label>
                </li>
              </ul>
            </div>

            <div class="col">
              <label for="format">
                <div>Repeat rows?
                  <label for="itemView.getDomIdToLabel()" aria-label="(Required field)"></label>
                </div>
              </label>
              <ul id="qb-grouping-list">
                <li>
                  <label>
                    <input type="radio" name="format" value="summary" id="format-1" aria-label="Summary"
                    {% if not format or (format and format == "summary") %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>No</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="format" value="by_sector" id="format-2" aria-label="By Sector"
                    {% if format and format == "by_sector" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>Multi-sector expansion</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="format" value="by_country" id="format-3" aria-label="By Country"
                    {% if format and format == "by_country" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>Multi-country expansion</span>
                  </label>
                </li>
              </ul>
            </div>

            <div class="col">
              <label for="sample-size">
                <div>Choose sample size
                  <label for="itemView.getDomIdToLabel()" aria-label="(Required field)"></label>
                </div>
              </label>
              <ul id="qb-sample-size">
                <li>
                  <label>
                    <input type="radio" name="sample-size" value="50 rows" id="sample-size-1" aria-label="50 rows"
                    {% if not size or (size and size == "50 rows") %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>50 rows</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="sample-size" value="Entire selection" id="sample-size-2" aria-label="Entire selection"
                    {% if size and size == "stream=True" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>Entire selection</span>
                  </label>
                </li>
              </ul>
            </div>
          </div>

          <div class="row form-group">
            <label for="reporting-org">
              <div>Select reporting organisation (eg UK DFID = GB-GOV-1)</div>
              <div dir="ltr"></div>
            </label>
            <div class="clearfix"></div>
            <select data-placeholder="Choose a reporting organisation..." multiple class="chosen-select form-control" id="reporting-org" name="reporting-org[]">
              {{ include('include/reporting_org.html') }}
            </select>
          </div>

          <div class="row form-group">
            <label for="reporting-org.type">
              <div>Select type of reporting organisation (eg. INGO = 21)</div>
            </label>
            <div class="clearfix"></div>
            <select data-placeholder="Choose a reporting organisation type..." multiple class="chosen-select form-control" id="reporting-org.type" name="reporting-org.type[]">
              {{ include('include/reporting_org_type.html') }}
            </select>
          </div>

          <div class="row form-group">
            <label for="sector">
              <div>Select sector (eg Basic Health Care = 12220)</div>
            </label>
            <div class="clearfix"></div>
            <select data-placeholder="Choose a sector..." multiple class="chosen-select form-control" id="sector" name="sector[]">
              {{ include('include/sector.html') }}
            </select>
          </div>

          <div class="row form-group">
            <fieldset>
              <legend>Select EITHER a country OR a region</legend>
              <div class="errorbox-good">
                <div dir="ltr">
                  <div>
                    <label for="recipient-country">
                      <div>Select recipient country</div>
                    </label>
                    <div class="clearfix"></div>
                    <select data-placeholder="Choose a country..." multiple class="chosen-select form-control" id="recipient-country" name="recipient-country[]">
                      {{ include('include/country.html') }}
                    </select>
                  </div>
                </div>
              </div>
              <div class="errorbox-good">
                <div dir="ltr">
                  <div>
                    <label for="recipient-region">
                      <div>Select region (eg South Asia = 679)</div>
                    </label>
                    <div class="clearfix"></div>
                    <select data-placeholder="Choose a region..." multiple class="chosen-select form-control" id="recipient-region" name="recipient-region[]">
                      {{ include('include/region.html') }}
                    </select>
                  </div>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="form-row">
            <div class="col">
              <noscript><button class="btn btn-primary" type="submit">Submit</button></noscript>
              <button class="btn btn-secondary" type="reset">Reset</button>
            </div>
          </div>

        </form>

        <div class="alert alert-success" id="js-query-link" role="alert">
          <p><strong>Your link:</strong> <a href="http://datastore.iatistandard.org/api/1/access/activity.csv">http://datastore.iatistandard.org/api/1/access/activity.csv</a></p>
        </div>

      </div><!-- end class="query-builder"-->


      <div class="row footer">
        <div class="col">
          <p>IATI Query Builder is free software licenced under the GNU General Public License.<br/>
          <ul>
            <li><a href="https://github.com/IATI/IATI-Query-Builder" target="_blank" rel="noopener noreferrer nofollow">IATI Query Builder on GitHub</a></li>
            <li>Please report problems to our <a href="https://github.com/IATI/IATI-Query-Builder/issues" target="_blank" rel="noopener noreferrer nofollow">issues list</a>.</li>
            <li>Datastore documentation: <a href="http://datastore.iatistandard.org/" target="_blank" rel="noopener noreferrer">http://datastore.iatistandard.org</a></li>
          </ul>
          </p>
        </div>
      </div><!-- end class="footer"-->


    </div><!-- end class="container"-->

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script src="static/js/chosen.jquery.js" type="text/javascript"></script>

<script type="text/javascript">
  $(".chosen-select").chosen()
</script>

<script type="text/javascript">
var QueryBuilder = QueryBuilder || {};
QueryBuilder.LinkGen = QueryBuilder.LinkGen || {};

/*
  Obtain the format.
*/
QueryBuilder.LinkGen.getFormat = function(){
  return $('#qb-format-list input:checked').attr('aria-label').toLowerCase();
};

/*
  Obtain the grouping.
*/
QueryBuilder.LinkGen.getGrouping = function(){
  var grouping =$('#qb-grouping-list input:checked').attr('aria-label');

  if(grouping === 'By Sector'){
    return '/by_sector';
  } else if(grouping === 'By Country'){
    return '/by_country';
  } else {
    return '';
  }
};

/*
  Obtain the sample size
*/
QueryBuilder.LinkGen.getSampleSize = function(){
  var sampleSize = $('#qb-sample-size input:checked').attr('aria-label');

  if(sampleSize === '50 rows'){
    return '';
  } else {
    return 'stream=True'
  }
};

/*
  Obtain info for a multi-select.
*/
QueryBuilder.LinkGen.getMultiSelectInfo = function(name){
  var separator = '%7C';
  var multiSelect = $('[name="' + name + '[]"]');
  var selectedOptions = $('[name="' + name + '[]"] option:checked');
  var values = [];

  // have to use forEach because querySelectorAll is a NodeList which doesn't have a `map()` function
  selectedOptions.each(function(){
    var value = $(this).attr('value');

    // do not include the 'None' values
    if(value !== ''){
      values.push(value);
    }
  });

  if(values.length === 0){
    return '';
  }

  return name + '=' + values.join(separator);
};

/*
  Convert an array of query string sections into a query string.
*/
QueryBuilder.LinkGen.createQueryString = function(sections){
  var filteredSections = sections.filter(function(section){
    return section !== '';
  });

  if(filteredSections.length === 0){
    return '';
  }

  return '?' + filteredSections.join('&');
};

/*
  Generate the link from the page.
*/
QueryBuilder.LinkGen.createLink = function(){
  var baseURL = 'http://datastore.iatistandard.org/api/1/access/';
  var format = QueryBuilder.LinkGen.getFormat();
  var grouping = QueryBuilder.LinkGen.getGrouping();
  var fileType = '.csv'
  var reportingOrgs = QueryBuilder.LinkGen.getMultiSelectInfo('reporting-org');
  var reportingOrgTypes = QueryBuilder.LinkGen.getMultiSelectInfo('reporting-org.type');
  var sectors = QueryBuilder.LinkGen.getMultiSelectInfo('sector');
  var recipientCountries = QueryBuilder.LinkGen.getMultiSelectInfo('recipient-country');
  var recipientRegions = QueryBuilder.LinkGen.getMultiSelectInfo('recipient-region');
  var sampleSize = QueryBuilder.LinkGen.getSampleSize();
  var queryString = QueryBuilder.LinkGen.createQueryString([reportingOrgs, reportingOrgTypes, sectors, recipientCountries, recipientRegions, sampleSize]);

  return baseURL + format + grouping + fileType + queryString;
};

/*
  Update the link displayed on the page.
*/
QueryBuilder.LinkGen.updateLink = function(){
  var linkElement = $('#js-query-link a');
  var linkLocation = QueryBuilder.LinkGen.createLink();

  // update the link
  linkElement.attr('href', linkLocation);
  linkElement.text(linkLocation);
};

/*
  Set the event listeners.
*/
QueryBuilder.LinkGen.SetupEventListeners = function(){
  var formElements = $('select, input[type=radio]');

  formElements.change(QueryBuilder.LinkGen.updateLink);
};

/*
  Initialise the client-side link generation.
*/
QueryBuilder.LinkGen.Init = function(){
  QueryBuilder.LinkGen.SetupEventListeners();
  QueryBuilder.LinkGen.updateLink();
};

/*
  Initialise the Query Builder JS.
*/
QueryBuilder.Init = function(){
  QueryBuilder.LinkGen.Init();
};

QueryBuilder.Init();
</script>

  </body>
</html>
