<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>IATI Data Store CSV Query Builder (Alpha Version)</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link href="static/css/custom.css" type="text/css" rel="stylesheet">
    <link href="static/css/bootstrap-chosen.css" type="text/css" rel="stylesheet">
  </head>
  <body dir="ltr">
    <div class="container">
      <div class="header row">
        <div class="col">
          <h1 dir="ltr">IATI Data Store CSV Query Builder (Alpha Version)</h1>
          <p>Please read the <a href="http://datastore.iatistandard.org/docs/user-guide/">user guide</a></p>
        </div>
      </div><!-- end class="header" -->

      <div class="query-builder">
        <div class="row"><!-- result -->
          {% if api_link %}
            <div class="alert alert-success" role="alert">
              <strong>Your link:</strong> <a href="{{ api_link }}">{{ api_link|escape }}</a>
            </div>

            {% if notice_message %}
              <div class="alert alert-warning" role="alert">
                <strong>Warning:</strong> {{ notice_message }}
              </div>
            {% endif %}

          {% elseif error_message %}
            <div class="alert alert-danger" role="alert">
              <strong>Error:</strong> {{ error_message }}
            </div>
          {% endif %}
        </div>

        <form action="index.php" method="post" target="_self" onsubmit="">

          <div class="form-row">
            <div class="col">
              <label for="entry_1689841214">
                <div>Choose format
                  <label for="itemView.getDomIdToLabel()" aria-label="(Required field)"></label>
                </div>
              </label>
              <ul id="qb-format-list">
                <li>
                  <label>
                    <input type="radio" name="entry.1085079344" value="activity" id="group_1085079344_1" aria-label="Activity"
                    {% if not dataset or (dataset and dataset == "activity") %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>One activity per row</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="entry.1085079344" value="transaction" id="group_1085079344_2" aria-label="Transaction"
                    {% if dataset and dataset == "transaction" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>One transaction per row</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="entry.1085079344" value="budget" id="group_1085079344_3" aria-label="Budget"
                    {% if dataset and dataset == "budget" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>One budget per row</span>
                  </label>
                </li>
              </ul>
            </div>

            <div class="col">
              <label for="entry_1948547450">
                <div>Repeat rows?
                  <label for="itemView.getDomIdToLabel()" aria-label="(Required field)"></label>
                </div>
              </label>
              <ul id="qb-grouping-list">
                <li>
                  <label>
                    <input type="radio" name="entry.71167035" value="summary" id="group_71167035_1" aria-label="Summary"
                    {% if not format or (format and format == "summary") %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>No</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="entry.71167035" value="by_sector" id="group_71167035_2" aria-label="By Sector"
                    {% if format and format == "by_sector" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>Multi-sector expansion</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="entry.71167035" value="by_country" id="group_71167035_3" aria-label="By Country"
                    {% if format and format == "by_country" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>Multi-country expansion</span>
                  </label>
                </li>
              </ul>
            </div>

            <div class="col">
              <label for="entry_1414120858">
                <div>Choose sample size
                  <label for="itemView.getDomIdToLabel()" aria-label="(Required field)"></label>
                </div>
              </label>
              <ul id="qb-sample-size">
                <li>
                  <label>
                    <input type="radio" name="entry.1352830161" value="50 rows" id="group_1352830161_1" aria-label="50 rows"
                    {% if not size or (size and size == "50 rows") %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>50 rows</span>
                  </label>
                </li>
                <li>
                  <label>
                    <input type="radio" name="entry.1352830161" value="Entire selection" id="group_1352830161_2" aria-label="Entire selection"
                    {% if size and size == "stream=True" %}
                      checked="checked"
                    {% endif %}
                    />
                    <span>Entire selection</span>
                  </label>
                </li>
              </ul>
            </div>
          </div>

          <div class="row form-group">
            <label for="entry_1922375458">
              <div>Select reporting organisation (eg UK DFID = GB-GOV-1)</div>
              <div dir="ltr"></div>
            </label>
            <div class="clearfix"></div>
            <select data-placeholder="Choose a reporting organisation..." multiple class="chosen-select form-control" id="entry_1922375458[]" name="entry.1922375458[]">
              {{ include('include/reporting_org.html') }}
            </select>
          </div>

          <div class="row form-group">
            <label for="entry_18398991">
              <div>Select type of reporting organisation (eg. INGO = 21)</div>
            </label>
            <div class="clearfix"></div>
            <select data-placeholder="Choose a reporting organisation type..." multiple class="chosen-select form-control" id="entry_18398991[]" name="entry.18398991[]">
              {{ include('include/reporting_org_type.html') }}
            </select>
          </div>

          <div class="row form-group">
            <label for="entry_1954968791">
              <div>Select sector (eg Basic Health Care = 12220)</div>
            </label>
            <div class="clearfix"></div>
            <select data-placeholder="Choose a sector..." multiple class="chosen-select form-control" id="entry_1954968791[]" name="entry.1954968791[]">
              {{ include('include/sector.html') }}
            </select>
          </div>

          <div class="row form-group">
            <fieldset>
              <legend>Select EITHER a country OR a region</legend>
              <div class="errorbox-good">
                <div dir="ltr">
                  <div>
                    <label for="entry_605980212">
                      <div>Select recipient country</div>
                    </label>
                    <div class="clearfix"></div>
                    <select data-placeholder="Choose a country..." multiple class="chosen-select form-control" id="entry_605980212[]" name="entry.605980212[]">
                      {{ include('include/country.html') }}
                    </select>
                  </div>
                </div>
              </div>
              <div class="errorbox-good">
                <div dir="ltr">
                  <div>
                    <label for="entry_1179181326">
                      <div>Select region (eg South Asia = 679)</div>
                    </label>
                    <div class="clearfix"></div>
                    <select data-placeholder="Choose a region..." multiple class="chosen-select form-control" id="entry_1179181326[]" name="entry.1179181326[]">
                      {{ include('include/region.html') }}
                    </select>
                  </div>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="form-row">
            <div class="col">
              <noscript><button class="btn btn-primary" type="submit">Submit</button></noscript>
              <button class="btn btn-secondary" type="reset">Reset</button>
            </div>
          </div>

        </form>

        <div class="alert alert-success" id="js-query-link" role="alert">
          <p><strong>Your link:</strong> <a id="query-link" href="http://datastore.iatistandard.org/api/1/access/activity.csv">http://datastore.iatistandard.org/api/1/access/activity.csv</a> <span id="preview-link-wrapper">(<a id="preview-link" href="http://preview.iatistandard.org/" target="_blank" rel="noopener noreferrer">Preview</a>)</span></p>
        </div>

      </div><!-- end class="query-builder"-->


      <div class="row footer">
        <div class="col">
          <p>IATI Query Builder is free software licenced under the GNU General Public License.<br/>
          <ul>
            <li><a href="https://github.com/IATI/IATI-Query-Builder" target="_blank" rel="noopener noreferrer nofollow">IATI Query Builder on GitHub</a></li>
            <li>Please report problems to our <a href="https://github.com/IATI/IATI-Query-Builder/issues" target="_blank" rel="noopener noreferrer nofollow">issues list</a>.</li>
            <li>Datastore documentation: <a href="http://datastore.iatistandard.org/" target="_blank" rel="noopener noreferrer">http://datastore.iatistandard.org</a></li>
          </ul>
          </p>
        </div>
      </div><!-- end class="footer"-->


    </div><!-- end class="container"-->

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script src="static/js/chosen.jquery.js" type="text/javascript"></script>

<script type="text/javascript">
  $(".chosen-select").chosen()
</script>

<script type="text/javascript">
var QueryBuilder = QueryBuilder || {};
QueryBuilder.LinkGen = QueryBuilder.LinkGen || {};
QueryBuilder.Preview = QueryBuilder.Preview || {};

/*
  Obtain the format.
*/
QueryBuilder.LinkGen.getFormat = function(){
  return $('#qb-format-list input:checked').attr('aria-label').toLowerCase();
};

/*
  Obtain the grouping.
*/
QueryBuilder.LinkGen.getGrouping = function(){
  var grouping =$('#qb-grouping-list input:checked').attr('aria-label');

  if(grouping === 'By Sector'){
    return '/by_sector';
  } else if(grouping === 'By Country'){
    return '/by_country';
  } else {
    return '';
  }
};

/*
  Obtain the sample size
*/
QueryBuilder.LinkGen.getSampleSize = function(){
  var sampleSize = $('#qb-sample-size input:checked').attr('aria-label');

  if(sampleSize === '50 rows'){
    return '';
  } else {
    return 'stream=True'
  }
};

/*
  Obtain info for a multi-select.
*/
QueryBuilder.LinkGen.getMultiSelectInfo = function(id, name){
  var separator = '%7C';
  var multiSelect = $('[name*="' + id + '"]');
  var selectedOptions = $('[name*="' + id + '"] option:checked');
  var values = [];

  // have to use forEach because querySelectorAll is a NodeList which doesn't have a `map()` function
  selectedOptions.each(function(){
    var value = $(this).attr('value');

    // do not include the 'None' values
    if(value !== ''){
      values.push(value);
    }
  });

  if(values.length === 0){
    return '';
  }

  return name + '=' + values.join(separator);
};

/*
  Convert an array of query string sections into a query string.
*/
QueryBuilder.LinkGen.createQueryString = function(sections){
  var filteredSections = sections.filter(function(section){
    return section !== '';
  });

  if(filteredSections.length === 0){
    return '';
  }

  return '?' + filteredSections.join('&');
};

/*
  Generate the link from the page.
*/
QueryBuilder.LinkGen.createLink = function(fileType){
  var baseURL = 'http://datastore.iatistandard.org/api/1/access/';
  var format = QueryBuilder.LinkGen.getFormat();
  var grouping = QueryBuilder.LinkGen.getGrouping();
  var reportingOrgs = QueryBuilder.LinkGen.getMultiSelectInfo('1922375458', 'reporting-org');
  var reportingOrgTypes = QueryBuilder.LinkGen.getMultiSelectInfo('18398991', 'reporting-org.type');
  var sectors = QueryBuilder.LinkGen.getMultiSelectInfo('1954968791', 'sector');
  var recipientCountries = QueryBuilder.LinkGen.getMultiSelectInfo('605980212', 'recipient-country');
  var recipientRegions = QueryBuilder.LinkGen.getMultiSelectInfo('1179181326', 'recipient-region');
  var sampleSize = QueryBuilder.LinkGen.getSampleSize();
  var queryString = QueryBuilder.LinkGen.createQueryString([reportingOrgs, reportingOrgTypes, sectors, recipientCountries, recipientRegions, sampleSize]);

  fileType = fileType || '.csv';

  return baseURL + format + grouping + fileType + queryString;
};

/*
  Update the link displayed on the page.
*/
QueryBuilder.LinkGen.updateLink = function(){
  var linkElement = $('#query-link');
  var linkLocation = QueryBuilder.LinkGen.createLink();

  // update the link
  linkElement.attr('href', linkLocation);
  linkElement.text(linkLocation);
};

/*
  Set the event listeners for the generated link.
*/
QueryBuilder.LinkGen.SetupEventListeners = function(){
  var formElements = $('select, input[type=radio]');

  formElements.change(QueryBuilder.LinkGen.updateLink);
};

/*
  Initialise the client-side link generation.
*/
QueryBuilder.LinkGen.Init = function(){
  QueryBuilder.LinkGen.SetupEventListeners();
  QueryBuilder.LinkGen.updateLink();
};

/*
  Generate the link to the Preview tool.
*/
QueryBuilder.Preview.createLink = function(){
  var unescapedLink = QueryBuilder.LinkGen.createLink('.xml');
  var previewBaseURL = 'http://preview.iatistandard.org/index.php?url=';

  // ensure it's only a Preview and not the full set of data being viewed
  var sampleSize = QueryBuilder.LinkGen.getSampleSize();

  if(sampleSize.length > 0){
    unescapedLink = unescapedLink.replace(sampleSize, '');
  }

  return previewBaseURL + encodeURIComponent(unescapedLink);
};

/*
  Update the integration with the Preview tool.
*/
QueryBuilder.Preview.updateLink = function(){
  var previewButtonElement = $('#preview-link');

  previewButtonElement.attr('href', QueryBuilder.Preview.createLink());
  QueryBuilder.Preview.updateVisibility();
};

/*
  Changes the Preview link visibility based on whether the data can be viewed using the Preview Tool.
*/
QueryBuilder.Preview.updateVisibility = function(){
  var format = QueryBuilder.LinkGen.getFormat();
  var grouping = QueryBuilder.LinkGen.getGrouping();
  var canPreview = (format === 'activity') && (grouping === '');
  var previewWrapper = $('#preview-link-wrapper');

  if(canPreview){
    previewWrapper.show();
  } else {
    previewWrapper.hide();
  }
};

/*
  Set the event listeners for the preview integration
*/
QueryBuilder.Preview.SetupEventListeners = function(){
  var formElements = $('select, input[type=radio]');

  formElements.change(QueryBuilder.Preview.updateLink);
};

/*
  Initialise the preview integration.
*/
QueryBuilder.Preview.Init = function(){
  QueryBuilder.Preview.SetupEventListeners();
  QueryBuilder.Preview.updateLink();
};

/*
  Initialise the Query Builder JS.
*/
QueryBuilder.Init = function(){
  QueryBuilder.LinkGen.Init();
  QueryBuilder.Preview.Init();
};

QueryBuilder.Init();
</script>

  </body>
</html>
